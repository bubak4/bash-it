#!/bin/bash
# Time-stamp: <2025-05-28 13:23:21 martin>
# gitw -- git wrapper for multiple repositories

# SCRIPTPATH="$( cd "$(dirname "$0")" ; pwd -P )"
# cd $SCRIPTPATH || exit 1

UPSTREAM=${UPSTREAM_REPO:-"origin"}
MASTER_BRANCH=${MASTER_BRANCH:-"master"}
DEFAULT_BRANCHES=${DEFAULT_BRANCHES:-"master release dev"}

function usage() {
  echo "Usage: $(basename $0) [cmd-merge|cmd-push|<git-command>]"
  echo
  echo "Set the environment variable DEFAULT_BRANCHES to a space-separated list of branches to use."
  echo "  Current settings: DEFAULT_BRANCHES=\"${DEFAULT_BRANCHES}\""
  exit 1
}

function comment_box() {
  local text="$1"
  local length=${#text}
  local border=$(printf '+%*s+\n' "$((length + 2))" '' | tr ' ' '-')

  echo "$border"
  echo "| $text |"
  echo "$border"
}

function find_config() {
  local cwd=$(pwd)
  local cfg=".gitwrapper"

  # Loop until we find .git-mine or reach the home directory
  while test "$cwd" != "/" ; do
    if test -f "$cwd/$cfg" ; then
      echo "${cwd}/${cfg}"
      break
    fi
    cwd=$(dirname "$cwd")
  done
}

# $1 .. cfg
function find_repos() {
  local cfg=$1

  if test -z "$cfg" ; then
    echo "unable to find config"
    exit 1
  fi

  for i in $(cat $cfg) ; do
    repo=$(realpath $(dirname $cfg)/$i)
    if test -d $repo -a -d $repo/.git ; then
      echo "$repo"
    fi
  done
}

# does not work very well (symlinks, terraform module referencing .git tags etc.)
function find_repos_fallback() {
  find $(pwd) -name .git -exec dirname {} \; 2>/dev/null
}

# "$@" .. command pass to git over repos
# uses global REPOS variable
function run_command() {
  comment_box "Running: git $*"
  for repo in $REPOS ; do
    cd $repo
    comment_box $(basename $repo)
    git "$@" || {
      echo "Error: git $* in $repo"
      exit 1
    }
  done
  comment_box "Done: git $*"
}

function create_default_branches() {
  $0 checkout $MASTER_BRANCH
  for i in $DEFAULT_BRANCHES ; do
    if test "$i" = "$MASTER_BRANCH" ; then
      continue
    fi
    $0 checkout -b $i $MASTER_BRANCH
    $0 push -u $UPSTREAM $i
  done
}

function merge_all() {
  for i in $DEFAULT_BRANCHES ; do
    $0 checkout $i
    $0 pull
  done

  log=""
  for i in $DEFAULT_BRANCHES ; do
    $0 checkout $i
    for j in $DEFAULT_BRANCHES ; do
      if test "$i" = "$j" ; then
        continue
      fi
      $0 merge $j
      log="$log\nmerge $i -> $j"
    done
  done
  comment_box ">> Merge Summary <<"
  echo -e $log
}

function push_all() {
  log=""
  for i in $DEFAULT_BRANCHES ; do
    $0 checkout $i
    $0 push "$UPSTREAM"
    log="$log\npush ${UPSTREAM}/${i}"
  done
  comment_box ">> Push Summary <<"
  echo -e $log
}

cfg=$(find_config)
REPOS=$(find_repos $cfg)

if test "$1" = "cmd-merge" ; then
  echo "Using default branches: $DEFAULT_BRANCHES"
  merge_all
elif test "$1" = "cmd-push" ; then
  echo "Using default branches: $DEFAULT_BRANCHES"
  push_all
elif test -z "$1" ; then
  usage
else
  run_command "$@"
fi
